10 使用ggtreeExtra 在环型布局上呈现数据
10.1 简介
	ggtree包[1]能帮助我们对系统发育树以及其他树形结构进行可编程的可视化。同时，它也支持将进化树相关数据以多个图层的形式在进化树上直接注释，或者是与树并排绘制（另见第 7 章及我们的文章[2]）。虽然ggtree支持以多种布局绘制进化树（参见4.2.2小节），但geom_facet() 图层却仅适用于直角矩形布局、环形布局、椭圆布局及倾斜布局。而ggtree也没有为环形布局、扇形布局或径向布局外圈数据的呈现提供直接的支持。为了解决这个问题，我们开发了ggtreeExtra包，它能帮助用户在环型布局树的外圈中绘制相关的图层，并将其与树结构对齐。同时它也兼容矩形布局的树（如图10.3所示）。

10.2 基于树的结构将图与树对齐
ggtreeExtra包提供了geom_fruit()图层函数，用于将外部图层与树结构并排对齐。与第 7 章中所介绍的 geom_facet() 布局类似，geom_fruit() 可在内部根据树结构对输入数据进行重新排序，并使用指定的几何对象图层通过用户提供的美学映射和非变量设置对数据进行可视化。可视化后生成的图形将显示在树的外圈（环型布局等）或者树的右侧（矩型布局）。

geom_fruit() 被设计为能够支持 ggplot2 及其扩展包中所定义的大部分 geom 图层。图的位置（即在树外圈上的位置）由 position 参数控制。position参数需要接收一个 Position 对象，其默认值是“auto”，此时geom_fruit() 图层函数会自行推断并为尝试所指定的几何对象图层确定合适的位置。在这个过程中，geom_fruit()会自动对geom_bar()使用position_stackx()，对geom_violin() 和 geom_boxplot() 使用position_dodgex()，以及对其他的几何图层使用position_identityx()（如geom_point() 和 geom_tile() 等），来调整他们的位置。任何带有position参数的几何图层都应该可以与geom_fruit()兼容，因为这样就能使在ggtreeExtra 包中定义的位置函数得以调整输出图层的位置。此外，通过使用axis.params 和grid.params 参数，我们还可以分别为当前的外部图层添加坐标轴和背景网格线。

	下例中我们使用phyloseq 包中提供的微生物组数据，并使用箱线图来对物种丰度数据进行可视化。geom_fruit() 图层根据环形树的结构自动重新排列丰度数据，并使用特定的 geom 函数（如geom_boxplot()）将数据可视化，如图10.1所示。我们文章[2]中的图 1还使用geom_density_ridges() 和 geom_facet()对此数据集进行了可视化。

library(ggtreeExtra)
library(ggtree)
library(phyloseq)
library(dplyr)

data("GlobalPatterns")
GP <- GlobalPatterns
GP <- prune_taxa(taxa_sums(GP) > 600, GP)
sample_data(GP)$human <- get_variable(GP, "SampleType") %in%
                              c("Feces", "Skin")
mergedGP <- merge_samples(GP, "SampleType")
mergedGP <- rarefy_even_depth(mergedGP,rngseed=394582)
mergedGP <- tax_glom(mergedGP,"Order")

melt_simple <- psmelt(mergedGP) %>%
               filter(Abundance < 120) %>%
               select(OTU, val=Abundance)

p <- ggtree(mergedGP, layout="fan", open.angle=10) + 
     geom_tippoint(mapping=aes(color=Phylum), 
                   size=1.5,
                   show.legend=FALSE)
p <- rotate_tree(p, -90)

p <- p +
     geom_fruit(
         data=melt_simple,
         geom=geom_boxplot,
         mapping = aes(
                     y=OTU,
                     x=val,
                     group=label,
                     fill=Phylum,
                   ),
         size=.2,
         outlier.size=0.5,
         outlier.stroke=0.08,
         outlier.shape=21,
         axis.params=list(
                         axis       = "x",
                         text.size  = 1.8,
                         hjust      = 1,
                         vjust      = 0.5,
                         nbreak     = 3,
                     ),
         grid.params=list()
     ) 

     p <- p +
     scale_fill_discrete(
         name="Phyla",
         guide=guide_legend(keywidth=0.8, keyheight=0.8, ncol=1)
     ) +
     theme(
         legend.title=element_text(size=9), 
         legend.text=element_text(size=7) 
     )
p



图 10.1：附有OTU 丰度分布的系统进化树
物种丰度分布信息在与树对齐后，以箱线图的形式被呈现出来。此例中我们使用物种所属的门信息对树上的符号点以及物种丰度分布图进行着色。

10.3 在多维数据的可视化中将多个图与树对齐
	我们可以为树添加多个geom_fruit()图层而对于多维数据的呈现来说，环形布局确实显得更为紧凑和高效。本例再现了相关文章[3]中的图2。数据由 GraPhlAn[4] 提供，其中包含不同身体部位微生物组的相对丰度。此例向我们展示了ggtreeExtra通过添加多个图层（本例中为热图和条形图）来呈现不同类型数据的能力（如图 10.2所示）

library(ggtreeExtra)
library(ggtree)
library(treeio)
library(tidytree)
library(ggstar)
library(ggplot2)
library(ggnewscale)
library(TDbook)
# 从TDbook里面加载数据，包括tree_hmptree、
# df_tippiont(微生物的丰度和类型）、
# df_ring_heatmap(微生物在人体不同部位的丰度）、
# 以及df_barplot_attr(流行率最高的微生物的丰度）
tree <- tree_hmptree
dat1 <- df_tippoint
dat2 <- df_ring_heatmap
dat3 <- df_barplot_attr

# 调整顺序
dat2$Sites <- factor(dat2$Sites, 
                    levels=c("Stool (prevalence)", "Cheek (prevalence)",
                             "Plaque (prevalence)","Tongue (prevalence)",
                             "Nose (prevalence)", "Vagina (prevalence)",
                             "Skin (prevalence)"))
dat3$Sites <- factor(dat3$Sites, 
                    levels=c("Stool (prevalence)", "Cheek (prevalence)",
                             "Plaque (prevalence)", "Tongue (prevalence)",
                             "Nose (prevalence)", "Vagina (prevalence)",
                             "Skin (prevalence)"))
# 提取进化枝标签信息
# 这是因为有些树的节点被注释至属水平，我们可以通过ggtree将其突出显示
nodeids <- nodeid(tree, tree$node.label[nchar(tree$node.label)>4])
nodedf <- data.frame(node=nodeids)
nodelab <- gsub("[\\.0-9]", "", tree$node.label[nchar(tree$node.label)>4])
# 进化枝以及突出显示的图层
poslist <- c(1.6, 1.4, 1.6, 0.8, 0.1, 0.25, 1.6, 1.6, 1.2, 0.4,
             1.2, 1.8, 0.3, 0.8, 0.4, 0.3, 0.4, 0.4, 0.4, 0.6,
             0.3, 0.4, 0.3)
labdf <- data.frame(node=nodeids, label=nodelab, pos=poslist)
# 环形布局树
p <- ggtree(tree, layout="fan", size=0.15, open.angle=5) +
     geom_hilight(data=nodedf, mapping=aes(node=node),
                  extendto=6.8, alpha=0.3, fill="grey", color="grey50",
                  size=0.05) +
     geom_cladelab(data=labdf, 
                   mapping=aes(node=node, 
                               label=label,
                               offset.text=pos),
                   hjust=0.5,
                   angle="auto",
                   barsize=NA,
                   horizontal=FALSE, 
                   fontsize=1.4,
                   fontface="italic"
                   )
p <- p %<+% dat1 + geom_star(
                        mapping=aes(fill=Phylum, starshape=Type, size=Size),
                        position="identity",starstroke=0.1) +
        scale_fill_manual(values=c("#FFC125","#87CEFA","#7B68EE","#808080",
                                "#800080", "#9ACD32","#D15FEE","#FFC0CB",
                                "#EE6A50","#8DEEEE", "#006400","#800000",
                                "#B0171F","#191970"),
                           guide=guide_legend(keywidth = 0.5, 
                                        keyheight = 0.5, order=1,
                                        override.aes=list(starshape=15)),
                           na.translate=FALSE)+
        scale_starshape_manual(values=c(15, 1),
                           guide=guide_legend(keywidth = 0.5, 
                                        keyheight = 0.5, order=2),
                           na.translate=FALSE)+
        scale_size_continuous(range = c(1, 2.5),
                           guide = guide_legend(keywidth = 0.5, 
                                        keyheight = 0.5, order=3,
                                        override.aes=list(starshape=15)))
                                                    p <- p + new_scale_fill() +
         geom_fruit(data=dat2, geom=geom_tile,
                  mapping=aes(y=ID, x=Sites, alpha=Abundance, fill=Sites),
                  color = "grey50", offset = 0.04,size = 0.02)+
         scale_alpha_continuous(range=c(0, 1),
                             guide=guide_legend(keywidth = 0.3, 
                                             keyheight = 0.3, order=5)) +
         geom_fruit(data=dat3, geom=geom_bar,
                    mapping=aes(y=ID, x=HigherAbundance, fill=Sites),
                    pwidth=0.38, 
                    orientation="y", 
                    stat="identity",
         ) +
         scale_fill_manual(values=c("#0000FF","#FFA500","#FF0000",
                                "#800000", "#006400","#800080","#696969"),
                           guide=guide_legend(keywidth = 0.3, 
                                        keyheight = 0.3, order=4))+
         geom_treescale(fontsize=2, linesize=0.3, x=4.9, y=0.1) +
         theme(legend.position=c(0.93, 0.5),
               legend.background=element_rect(fill=NA),
               legend.title=element_text(size=6.5),
               legend.text=element_text(size=4.5),
               legend.spacing.y = unit(0.02, "cm"),
             )
p



图 10.2：在系统发育树上呈现微生物组数据（丰度和位置）
进化树由符号点、突出显示的进化枝以及进化枝标签进行注释。 本例使用了两个 geom_fruit() 层来对位置和丰度信息进行可视化。

	本例中叶节点的形状表明了微生物的类型（共生微生物或潜在病原体），热图的透明度表明了微生物的丰度，热图的颜色表示人体的不同部位，柱状图表示对应身体部位的相对丰度最高物种的丰度。同时还利用节点标签中所包含的分类学信息为对应的进化枝添加标签，并突出显示。

geom_fruit() 图层还支持矩形布局。 用户可以直接为矩形布局的树添加geom_fruit() 图层（例如 ggtree(tree_object) + geom_fruit(...)），或使用 layout_rectangular() 将环形布局树转换为矩形布局树，如图 10.3所示。


图 10.3：对矩形布局的树使用geom_fruit()的示例
本图是通过将图10.2转换为矩形布局生成的。我们同样可以将矩形布局的树转换回圆形布局。

10.4 群体遗传学示例
	ggtree[1]和 ggtreeExtra 包在设计之初是要能作为通用工具被应用于许多研究领域，如传染病流行病学、宏基因组学、群体遗传学、进化生物学和生态学。在此之前，我们已经介绍了在宏基因组研究中使用ggtreeExtra的示例（如图 10.1 和图 10.2所示）。在本节中，我们将通过对相关文章[5]中的图4以及另一文章[6]中的图 1进行复现，来展示其在群体遗传学中的应用。

library(ggtree)
library(ggtreeExtra)
library(ggplot2)
library(ggnewscale)
library(reshape2)
library(dplyr)
library(tidytree)
library(ggstar)
library(TDbook)
# 从TD包里面加载tr和dat数据
dat <- df_Candidaauris_data
tr <- tree_Candidaauris
countries <- c("Canada", "United States",
               "Colombia", "Panama",
               "Venezuela", "France",
               "Germany", "Spain",
               "UK", "India",
               "Israel", "Pakistan",
               "Saudi Arabia", "United Arab Emirates",
               "Kenya", "South Africa",
               "Japan", "South Korea",
               "Australia")# For the tip points
dat1 <- dat %>% select(c("ID", "COUNTRY", "COUNTRY__colour"))
dat1$COUNTRY <- factor(dat1$COUNTRY, levels=countries)
COUNTRYcolors <- dat1[match(countries,dat$COUNTRY),"COUNTRY__colour"]
# 绘制热图图层
dat2 <- dat %>% select(c("ID", "FCZ", "AMB", "MCF"))
dat2 <- melt(dat2,id="ID", variable.name="Antifungal", value.name="type")
dat2$type <- paste(dat2$Antifungal, dat2$type)
dat2$type[grepl("Not_", dat2$type)] = "Susceptible"
dat2$Antifungal <- factor(dat2$Antifungal, levels=c("FCZ", "AMB", "MCF"))
dat2$type <- factor(dat2$type,
                    levels=c("FCZ Resistant",
                            "AMB Resistant",
                            "MCF Resistant",
                            "Susceptible"))
#绘制点图图层
dat3 <- dat %>% select(c("ID", "ERG11", "FKS1")) %>%
        melt(id="ID", variable.name="point", value.name="mutation")
dat3$mutation <- paste(dat3$point, dat3$mutation)
dat3$mutation[grepl("WT", dat3$mutation)] <- NA
dat3$mutation <- factor(dat3$mutation, 
                        levels=c("ERG11 Y132F", "ERG11 K143R",
                                 "ERG11 F126L", "FKS1 S639Y/P/F"))
# 设置进化枝组别信息
dat4 <- dat %>% select(c("ID", "CLADE"))
dat4 <- aggregate(.~CLADE, dat4, FUN=paste, collapse=",")
clades <- lapply(dat4$ID, function(x){unlist(strsplit(x,split=","))})
names(clades) <- dat4$CLADE
tr <- groupOTU(tr, clades, "Clade")
Clade <- NULL
p <- ggtree(tr=tr, layout="fan", open.angle=15, size=0.2, aes(colour=Clade)) +
     scale_colour_manual(
         values=c("black","#69B920","#9C2E88","#F74B00","#60C3DB"),
         labels=c("","I", "II", "III", "IV"),
         guide=guide_legend(keywidth=0.5,
                            keyheight=0.5,
                            order=1,
                            override.aes=list(linetype=c("0"=NA,
                                                         "Clade1"=1,
                                                         "Clade2"=1,
                                                         "Clade3"=1,
                                                         "Clade4"=1
                                                        )
                                             )
                           )
     ) + 
     new_scale_colour()
p1 <- p %<+% dat1 +
     geom_tippoint(aes(colour=COUNTRY),
                   alpha=0) +
     geom_tiplab(aes(colour=COUNTRY),
                   align=TRUE,
                   linetype=3,
                   size=1,
                   linesize=0.2,
                   show.legend=FALSE
                   ) +
     scale_colour_manual(
         name="Country labels",
         values=COUNTRYcolors,
         guide=guide_legend(keywidth=0.5,
                            keyheight=0.5,
                            order=2,
                            override.aes=list(size=2,alpha=1))
     )
p2 <- p1 +
      geom_fruit(
          data=dat2,
          geom=geom_tile,
          mapping=aes(x=Antifungal, y=ID, fill=type),
          width=0.1,
          color="white",
          pwidth=0.1,
          offset=0.15
      ) +
      scale_fill_manual(
           name="Antifungal susceptibility",
           values=c("#595959", "#B30000", "#020099", "#E6E6E6"),
           na.translate=FALSE,
           guide=guide_legend(keywidth=0.5,
                              keyheight=0.5,
                              order=3
                             )
      ) +
      new_scale_fill()
p3 <- p2 +
      geom_fruit(
          data=dat3,
          geom=geom_star,
          mapping=aes(x=mutation, y=ID, fill=mutation, starshape=point),
          size=1,
          starstroke=0,
          pwidth=0.1,
          inherit.aes = FALSE,
          grid.params=list(
                          linetype=3,
                          size=0.2
                      )

      ) +
      scale_fill_manual(
          name="Point mutations",
          values=c("#329901", "#0600FF", "#FF0100", "#9900CC"),
          guide=guide_legend(keywidth=0.5, keyheight=0.5, order=4,
                             override.aes=list(
                                    starshape=c("ERG11 Y132F"=15,
                                                "ERG11 K143R"=15,
                                                "ERG11 F126L"=15,
                                                "FKS1 S639Y/P/F"=1),
                                    size=2)
                            ),
          na.translate=FALSE,
      ) +
      scale_starshape_manual(
          values=c(15, 1),
          guide="none"
      ) +
      theme(
          legend.background=element_rect(fill=NA),
          legend.title=element_text(size=7), 
          legend.text=element_text(size=5.5),
          legend.spacing.y = unit(0.02, "cm")
      )
p3



图 10.4耳念珠菌（candida auris）对抗真菌药物的敏感性及其药物靶点上的点突变

在本例中，我们通过使用不同的颜色来呈现不同的进化枝来对进化树进行注释，如图10.4所示。外圈的热图则显示了耳念珠菌对氟康唑 （fluconazole，FCZ）、两性霉素 B （amphotericin B，AMB）及米卡芬净 （micafungin，MCF）的敏感性。外圈的点图则显示了羊毛甾醇 14-α-脱甲基酶 ERG11（Y132F、K143R 和 F126L）和β-1,3-D-葡聚糖合酶 FKS1（S639Y/P/F）中与抗药性相关的点突变[7]。 

library(ggtreeExtra)
library(ggtree)
library(ggplot2)
library(ggnewscale)
library(treeio)
library(tidytree)
library(dplyr)
library(ggstar)
library(TDbook)
# 从TDbook中加载tree_NJIDqgsS 和df_NJIDqgsS 数据
tr <- tree_NJIDqgsS
metada <- df_NJIDqgsS
metadata <- metada %>%
            select(c("id", "country", "country__colour", 
                    "year", "year__colour", "haplotype"))
metadata$haplotype[nchar(metadata$haplotype) == 0] <- NA
countrycolors <- metada %>%
                 select(c("country", "country__colour")) %>%
                 distinct()
yearcolors <- metada %>%
              select(c("year", "year__colour")) %>%
              distinct()
yearcolors <- yearcolors[order(yearcolors$year, decreasing=TRUE),]
metadata$country <- factor(metadata$country, levels=countrycolors$country)
metadata$year <- factor(metadata$year, levels=yearcolors$year)
p <- ggtree(tr, layout="fan", open.angle=15, size=0.1)
p <- p %<+% metadata
p1 <-p +
     geom_tippoint(
         mapping=aes(colour=country),
         size=1.5,
         stroke=0,
         alpha=0.4
     ) +
     scale_colour_manual(
         name="Country",
         values=countrycolors$country__colour,
         guide=guide_legend(keywidth=0.3,
                            keyheight=0.3,
                            ncol=2,
                            override.aes=list(size=2,alpha=1),
                            order=1)
     ) +
     theme(
         legend.title=element_text(size=5),
         legend.text=element_text(size=4),
         legend.spacing.y = unit(0.02, "cm")
     )
p2 <-p1 +
     geom_fruit(
         geom=geom_star,
         mapping=aes(fill=haplotype),
         starshape=26,
         color=NA,
         size=2,
         starstroke=0,
         offset=0,
     ) +
     scale_fill_manual(
         name="Haplotype",
         values=c("red"),
         guide=guide_legend(
                   keywidth=0.3,
                   keyheight=0.3,
                   order=3
               ),
         na.translate=FALSE
     )
p3 <-p2 +
     new_scale_fill() +
     geom_fruit(
         geom=geom_tile,
         mapping=aes(fill=year),
         width=0.002,
         offset=0.1
     ) +
     scale_fill_manual(
         name="Year",
         values=yearcolors$year__colour,
         guide=guide_legend(keywidth=0.3, keyheight=0.3, ncol=2, order=2)
     ) +
     theme(
           legend.title=element_text(size=6), 
           legend.text=element_text(size=4.5),
           legend.spacing.y = unit(0.02, "cm")
           )
p3


图 10.5：1,832 株伤寒沙门菌分离株的种群结构

图10.5呈现了一个由22145个SNPs[6]推断出的伤寒沙门菌的最大似然有根树。其中叶节点的颜色代表了分离株的发源地，红色符号点表示H58 世系的单倍型，外圈热图的颜色则代表了菌株分离的年份[6]。

10.5 总结
	相比于geom_facet() ，ggtreeExtra 中提供的 geom_fruit() 图层是我们在文章[2]中提出的第二种方法的更好的实现。geom_facet() 和 geom_fruit() 具有相同的设计理念和相似的用户接口。 他们都需要依靠其他几何对象图层来对树相关数据进行可视化。这些图层是由ggplot2 及其扩展包（包括ggtree）所提供，而随着在ggplot2社区中所实现的图层变得越来越多，geom_facet() 和 geom_fruit() 所能呈现的数据及图形的类型也将随之而增加。



参考文献：
[1]	Yu G, Smith D K, Zhu H, et al. Ggtree: An r package for visualization and annotation of phylogenetic trees with their covariates and other associated data[J]. Methods in Ecology and Evolution, 2016,8(1):28-36.
[2]	Yu G, Lam T T, Zhu H, et al. Two Methods for Mapping and Visualizing Associated Data on Phylogeny Using Ggtree[J]. Mol Biol Evol, 2018,35(12):3041-3043.
[3]	Morgan X C, Segata N, Huttenhower C. Biodiversity and functional genomics in the human microbiome[J]. Trends Genet, 2013,29(1):51-58.
[4]	Asnicar F, Weingart G, Tickle T L, et al. Compact graphical representation of phylogenetic data and metadata with GraPhlAn[J]. PeerJ, 2015,3:e1029.
[5]	Chow N A, Munoz J F, Gade L, et al. Tracing the Evolutionary History and Global Expansion of Candida auris Using Population Genomic Analyses[J]. mBio, 2020,11(2).
[6]	Wong V K, Baker S, Pickard D J, et al. Phylogeographical analysis of the dominant multidrug-resistant H58 clade of Salmonella Typhi identifies inter- and intracontinental transmission events[J]. Nat Genet, 2015,47(6):632-639.
[7]	Chow N A, Munoz J F, Gade L, et al. Tracing the Evolutionary History and Global Expansion of Candida auris Using Population Genomic Analyses[J]. mBio, 2020,11(2).
